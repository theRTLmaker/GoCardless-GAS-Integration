<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #f5f5f5;
      }
      h2 {
        color: #333;
        margin-bottom: 15px;
      }
      p {
        color: #666;
        margin-bottom: 20px;
      }
      .field-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        background-color: #fff;
        padding: 10px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .field-label {
        flex: 1;
        display: flex;
        align-items: center;
      }
      .column-input {
        width: 40px;
        text-align: center;
        margin-left: 10px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
      }
      .column-input.invalid {
        border-color: red;
      }
      button {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background-color: #45a049;
      }
      button:disabled {
        background-color: #cccccc;
        color: #666666;
        cursor: not-allowed;
      }
      .tooltip {
        position: relative;
        display: inline-block;
        margin-left: 5px;
        cursor: help;
        width: 16px;
        height: 16px;
        background-color: #777;
        color: #fff;
        border-radius: 50%;
        text-align: center;
        line-height: 16px;
        font-size: 12px;
      }
      .tooltip .tooltiptext {
        visibility: hidden;
        width: 200px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }
      .column-input::placeholder {
        color: #999;
      }
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0,0,0,.3);
        border-radius: 50%;
        border-top-color: #000;
        animation: spin 1s ease-in-out infinite;
        -webkit-animation: spin 1s ease-in-out infinite;
        margin-left: 10px;
        vertical-align: middle;
      }
      @keyframes spin {
        to { -webkit-transform: rotate(360deg); }
      }
      @-webkit-keyframes spin {
        to { -webkit-transform: rotate(360deg); }
      }
    </style>
    <script>
      const savedMappings = {{SAVED_MAPPINGS}};

      function loadMappings() {
        google.script.run.withSuccessHandler(populateForm).getTransactionFieldsWithDescriptions();
      }

      function populateForm(fields) {
        const form = document.getElementById('mappingForm');
        fields.forEach(({field, description, tooltip}) => {
          const div = document.createElement('div');
          div.className = 'field-row';

          const labelDiv = document.createElement('div');
          labelDiv.className = 'field-label';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `check_${field}`;
          checkbox.name = field;
          checkbox.addEventListener('change', updateSaveButtonState);

          const label = document.createElement('label');
          label.htmlFor = `check_${field}`;
          label.textContent = description;

          const tooltipSpan = document.createElement('span');
          tooltipSpan.className = 'tooltip';
          tooltipSpan.textContent = '?';
          const tooltipText = document.createElement('span');
          tooltipText.className = 'tooltiptext';
          tooltipText.textContent = tooltip;
          tooltipSpan.appendChild(tooltipText);

          labelDiv.appendChild(checkbox);
          labelDiv.appendChild(label);
          labelDiv.appendChild(tooltipSpan);

          const columnInput = document.createElement('input');
          columnInput.type = 'text';
          columnInput.id = `column_${field}`;
          columnInput.className = 'column-input';
          columnInput.maxLength = 3;
          columnInput.placeholder = savedMappings[field] || 'Col';
          columnInput.addEventListener('input', validateColumnInput);

          // Pre-select checkbox and set value if it exists in saved mappings
          if (savedMappings[field]) {
            checkbox.checked = true;
            columnInput.value = savedMappings[field];
          }

          div.appendChild(labelDiv);
          div.appendChild(columnInput);

          form.appendChild(div);
        });

        updateSaveButtonState();
      }

      function validateColumnInput(event) {
        const input = event.target;
        const value = input.value.toUpperCase();
        const isValid = /^[A-Z]{1,3}$/.test(value);

        if (isValid) {
          input.classList.remove('invalid');
          input.value = value;
        } else {
          input.classList.add('invalid');
        }

        // Clear placeholder when user starts typing
        if (value) {
          input.placeholder = '';
        } else {
          // Restore placeholder when input is empty
          const field = input.id.replace('column_', '');
          const savedMapping = getSavedMapping(field);
          input.placeholder = savedMapping || 'Col';
        }

        updateSaveButtonState();
      }

      function updateSaveButtonState() {
        const saveButton = document.getElementById('saveButton');
        const form = document.getElementById('mappingForm');
        const checkedInputs = form.querySelectorAll('input[type="checkbox"]:checked');
        const invalidInputs = form.querySelectorAll('.column-input.invalid');
        const emptyInputs = Array.from(checkedInputs).filter(checkbox => {
          const columnInput = document.getElementById(`column_${checkbox.name}`);
          return !columnInput.value;
        });

        // Disable save button if no checkboxes are selected, or if any selected checkbox has an empty or invalid column input
        saveButton.disabled = checkedInputs.length === 0 || invalidInputs.length > 0 || emptyInputs.length > 0;
      }

      function saveMappings() {
        const saveButton = document.getElementById('saveButton');
        const spinner = document.getElementById('spinner');

        // Disable the save button and show the spinner
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';
        spinner.style.display = 'inline-block';

        const form = document.getElementById('mappingForm');
        const mappings = {};

        for (let div of form.getElementsByClassName('field-row')) {
          const checkbox = div.querySelector('input[type="checkbox"]');
          const columnInput = div.querySelector('.column-input');
          if (checkbox.checked && columnInput.value) {
            mappings[checkbox.name] = columnInput.value.toUpperCase();
          }
        }

        google.script.run
          .withSuccessHandler(function() {
            closeDialog();
          })
          .withFailureHandler(function(error) {
            // Re-enable the save button and hide the spinner
            saveButton.disabled = false;
            saveButton.textContent = 'Save';
            spinner.style.display = 'none';

            // Show error message
            alert('Error saving mappings: ' + error.message);
          })
          .updateColumnMappings(mappings);
      }

      function closeDialog() {
        google.script.host.close();
      }

      function getSavedMapping(field) {
        return savedMappings[field] || '';
      }
    </script>
  </head>
  <body onload="loadMappings()">
    <p>Select the fields to display and specify their column letters.</p>
    <form id="mappingForm">
      <!-- Fields will be dynamically populated here -->
    </form>
    <button id="saveButton" onclick="saveMappings()" style="margin-top: 20px;">Save</button>
    <div id="spinner" class="spinner" style="display: none;"></div>
  </body>
</html>